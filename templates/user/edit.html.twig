{% extends 'indexback.html.twig' %}

{% block title %}Modifier un Utilisateur{% endblock %}

{% block stylesheets %}
  {{ parent() }}
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
  <style>
    .form-container {
      background-color: #fff;
      border-radius: 12px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
      transition: all 0.3s ease;
    }
    
    .form-container:hover {
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
    }
    
    .form-header {
      background: linear-gradient(to right, #4361ee, #4895ef);
      color: white;
      border-radius: 12px 12px 0 0;
      padding: 20px 30px;
      margin-bottom: 0;
    }
    
    .form-body {
      padding: 30px;
    }
    
    .input-group-text {
      background-color: #f0f4f8;
      border-color: #dee2e6;
    }
    
    .form-control:focus {
      border-color: #4361ee;
      box-shadow: 0 0 0 0.25rem rgba(67, 97, 238, 0.25);
    }
    
    .form-label {
      font-weight: 500;
      color: #495057;
    }
    
    .role-options {
      background-color: #f8f9fa;
      border-radius: 8px;
      padding: 15px;
      margin-top: 5px;
    }
    
    .role-option {
      transition: all 0.2s ease;
      padding: 8px 12px;
      border-radius: 6px;
    }
    
    .role-option:hover {
      background-color: #e9ecef;
    }
    
    .action-buttons {
      border-top: 1px solid #e9ecef;
      padding-top: 20px;
      margin-top: 20px;
    }
    
    .btn-update {
      background-color: #4361ee;
      border-color: #4361ee;
    }
    
    .btn-update:hover {
      background-color: #3a56d4;
      border-color: #3a56d4;
    }
    
    .preview-image {
      max-width: 150px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .file-upload {
      position: relative;
      overflow: hidden;
      margin-top: 10px;
    }
    
    .file-upload-label {
      display: block;
      background-color: #e9ecef;
      color: #495057;
      border: 1px solid #ced4da;
      padding: 8px 12px;
      border-radius: 4px;
      text-align: center;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    .file-upload-label:hover {
      background-color: #d1d7dd;
    }
    
    .upload-indicator {
      font-size: 0.85rem;
      color: #6c757d;
      margin-top: 5px;
    }
    
    .empty-feedback {
      color: #6c757d;
      font-style: italic;
      font-size: 0.85rem;
    }
    
    @media (max-width: 768px) {
      .form-body {
        padding: 20px;
      }
    }
  </style>
{% endblock %}

{% block body %}
<div class="container py-4 animate__animated animate__fadeIn">
  <div class="row justify-content-center">
    <div class="col-lg-10">
      <div class="form-container">
        <h1 class="form-header">
          <i class="bi bi-person-gear"></i> Modifier l'utilisateur
        </h1>
        
        <div class="form-body">
          {{ form_start(form, {'attr': {'novalidate': 'novalidate', 'id': 'editUserForm'}}) }}
          
          <div class="row g-4">
            <!-- Colonne gauche -->
            <div class="col-lg-6">
              <div class="mb-3">
                {{ form_label(form.email, 'Adresse Email', {'label_attr': {'class': 'form-label'}}) }}
                <div class="input-group">
                  <span class="input-group-text"><i class="bi bi-envelope-fill"></i></span>
                  {{ form_widget(form.email, {'attr': {'class': 'form-control'}}) }}
                </div>
                <div class="text-danger small">{{ form_errors(form.email) }}</div>
              </div>
              
              <div class="mb-3">
                {{ form_label(form.first_name, 'Prénom', {'label_attr': {'class': 'form-label'}}) }}
                <div class="input-group">
                  <span class="input-group-text"><i class="bi bi-person-fill"></i></span>
                  {{ form_widget(form.first_name, {'attr': {'class': 'form-control'}}) }}
                </div>
                <div class="text-danger small">{{ form_errors(form.first_name) }}</div>
              </div>
              
              <div class="mb-3">
                {{ form_label(form.last_name, 'Nom', {'label_attr': {'class': 'form-label'}}) }}
                <div class="input-group">
                  <span class="input-group-text"><i class="bi bi-person-badge-fill"></i></span>
                  {{ form_widget(form.last_name, {'attr': {'class': 'form-control'}}) }}
                </div>
                <div class="text-danger small">{{ form_errors(form.last_name) }}</div>
              </div>
              
              <div class="mb-3">
                {{ form_label(form.cin, 'CIN', {'label_attr': {'class': 'form-label'}}) }}
                <div class="input-group">
                  <span class="input-group-text"><i class="bi bi-credit-card-2-front-fill"></i></span>
                  {{ form_widget(form.cin, {'attr': {'class': 'form-control'}}) }}
                </div>
                <div class="text-danger small">{{ form_errors(form.cin) }}</div>
              </div>
              
              <div class="mb-3">
                {{ form_label(form.phone_number, 'Téléphone', {'label_attr': {'class': 'form-label'}}) }}
                <div class="input-group">
                  <span class="input-group-text"><i class="bi bi-telephone-fill"></i></span>
                  {{ form_widget(form.phone_number, {'attr': {'class': 'form-control'}}) }}
                </div>
                <div class="text-danger small">{{ form_errors(form.phone_number) }}</div>
              </div>
            </div>
            
            <!-- Colonne droite -->
            <div class="col-lg-6">
              <div class="mb-4">
                {{ form_label(form.salary, 'Salaire', {'label_attr': {'class': 'form-label'}}) }}
                <div class="input-group">
                  <span class="input-group-text"><i class="bi bi-currency-dollar"></i></span>
                  {{ form_widget(form.salary, {'attr': {'class': 'form-control'}}) }}
                  <span class="input-group-text">DT</span>
                </div>
                <div class="text-danger small">{{ form_errors(form.salary) }}</div>
              </div>
              
              <div class="mb-4">
                {{ form_label(form.cv, 'CV', {'label_attr': {'class': 'form-label'}}) }}
                {% if user is defined and user.cv %}
                  <div class="d-flex align-items-center mb-2">
                    <i class="bi bi-file-earmark-pdf text-danger me-2" style="font-size: 1.5rem;"></i>
                    <a href="{{ asset('uploads/cvs/' ~ user.cv) }}" target="_blank" class="text-decoration-none">
                      {{ user.cv }}
                    </a>
                  </div>
                {% endif %}
                {{ form_widget(form.cv, {'attr': {'class': 'form-control'}}) }}
                <div class="upload-indicator">
                  <i class="bi bi-info-circle"></i> Format accepté: PDF
                </div>
                <div class="text-danger small">{{ form_errors(form.cv) }}</div>
              </div>
              
              <div class="mb-4">
                {{ form_label(form.profile_photo, 'Photo de profil', {'label_attr': {'class': 'form-label'}}) }}
                {% if user is defined and user.profilePhoto %}
                  <div class="mb-2">
                    <img src="{{ asset('uploads/profile_photos/' ~ user.profilePhoto) }}" class="preview-image mb-2" alt="Photo actuelle">
                  </div>
                {% endif %}
                {{ form_widget(form.profile_photo, {'attr': {'class': 'form-control'}}) }}
                <div class="upload-indicator">
                  <i class="bi bi-info-circle"></i> Formats acceptés: JPG, PNG, GIF
                </div>
                <div class="text-danger small">{{ form_errors(form.profile_photo) }}</div>
              </div>
            </div>
          </div>
          <div class="form-group mt-4">
  {{ form_label(form.isVerified, 'Statut du compte', {'label_attr': {'class': 'form-label fw-bold'}}) }}
  <div class="form-check form-switch">
    {{ form_widget(form.isVerified, {'attr': {'class': 'form-check-input'}}) }}
    <label class="form-check-label" for="{{ form.isVerified.vars.id }}">
      {{ form.isVerified.vars.value ? 'Activé' : 'Désactivé' }}
    </label>
  </div>
  <div class="text-danger small">{{ form_errors(form.isVerified) }}</div>
</div>

          <!-- Rôles -->
          <div class="form-group mt-4">
            <label class="form-label fw-bold">Rôle</label>
            <div class="role-options">
              <div class="d-flex flex-wrap gap-3">
                {% for child in form.role %}
                  <div class="form-check role-option">
                    {{ form_widget(child, {'attr': {'class': 'form-check-input'}}) }}
                    {{ form_label(child, null, {'label_attr': {'class': 'form-check-label fw-medium'}}) }}
                    <div class="text-danger small">{{ form_errors(child) }}</div>
                  </div>
                {% endfor %}
              </div>
            </div>
          </div>
          
          <!-- Boutons d'action -->
          <div class="action-buttons d-flex justify-content-between">
            <a href="{{ path('app_user_list') }}" class="btn btn-outline-secondary">
              <i class="bi bi-arrow-left"></i> Retour à la liste
            </a>
            <div>
              <button type="button" class="btn btn-warning me-2" onclick="resetForm()">
                <i class="bi bi-x-circle"></i> Annuler
              </button>
              <button type="submit" class="btn btn-update text-white">
                <i class="bi bi-check2-circle"></i> Mettre à jour
              </button>
            </div>
          </div>
          
          {{ form_end(form) }}
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block javascripts %}
{{ parent() }}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Preview des fichiers uploadés
    const photoInput = document.querySelector('input[type="file"][name$="[profile_photo]"]');
    const cvInput = document.querySelector('input[type="file"][name$="[cv]"]');
    
    if (photoInput) {
      photoInput.addEventListener('change', function() {
        const file = this.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            let existingPreview = photoInput.previousElementSibling.querySelector('img');
            
            if (!existingPreview) {
              existingPreview = document.createElement('img');
              existingPreview.classList.add('preview-image', 'mb-2');
              const container = document.createElement('div');
              container.classList.add('mb-2');
              container.appendChild(existingPreview);
              photoInput.parentNode.insertBefore(container, photoInput);
            }
            
            existingPreview.src = e.target.result;
          }
          reader.readAsDataURL(file);
        }
      });
    }
    
    if (cvInput) {
      cvInput.addEventListener('change', function() {
        const file = this.files[0];
        if (file) {
          // Afficher le nom du fichier sélectionné
          let fileInfo = this.previousElementSibling;
          if (!fileInfo || !fileInfo.classList.contains('file-info')) {
            fileInfo = document.createElement('div');
            fileInfo.classList.add('d-flex', 'align-items-center', 'mb-2', 'file-info');
            fileInfo.innerHTML = 
              <i class="bi bi-file-earmark-pdf text-danger me-2" style="font-size: 1.5rem;"></i>
              <span class="file-name"></span>
            ;
            this.parentNode.insertBefore(fileInfo, this);
          }
          fileInfo.querySelector('.file-name').textContent = file.name;
        }
      });
    }
  });
  
  function resetForm() {
    Swal.fire({
      title: 'Êtes-vous sûr(e) ?',
      text: "Les modifications non sauvegardées seront perdues.",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#3085d6',
      cancelButtonColor: '#d33',
      confirmButtonText: 'Oui, annuler',
      cancelButtonText: 'Non, continuer'
    }).then((result) => {
      if (result.isConfirmed) {
        document.getElementById('editUserForm').reset();
        Swal.fire(
          'Réinitialisé !',
          'Les modifications ont été annulées.',
          'success'
        );
      }
    });
  }
</script>

{% endblock %}

